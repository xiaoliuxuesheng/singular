# 第一章 基础概念

## 1.1 什么是事务

- 事务是对数据的操作：要完成一个功能需要对数据库操作次，事务是指一个完成功能的实现中的多个数据库的操作要么全部成功，要不全部失败

## 1.2 本地事务

- 计算机业务更多是通过关系型数据库来控制事务：利用数据库本身的事务特性实现，数据库的事务特性
  1. A（Atomic）：原子性
  2. C（Consistency）：一致性
  3. I（Isolation）：隔离性
  4. D（Durability）：持久性

## 1.3 分布式事务

![image-20220522102423987](.\resource\point11_seata\image-20220522102423987.png)

- 分布式系统会把应用拆分为独立部署的多个服务，并且需要服务之间协调完成对不同的数据实现事务功能称为分布式事务；

## 1.4 分布式事务场景

1. 典型的场景就是微服务架构：如订单服务、库存服务的完整性；
2. 单体系统访问多个数据库实例：跨数据库实例产生分布式问题；
3. 多服务访问同一个数据库实例：

# 第二章 分布式事务理论

## 2.1 CAP理论

1. CAP是Consistency、Availability、Partition tolerance的缩写，分步表示一致性、可用性、分区容错性；
   - Consistency：是指写操作后的读操作可以读到最新的数据状态，单数据分步在多个节点上，从任意节点读取到的数据都是最新状态；一致性的特点：
     - 由于存在数据库同步过程，写操作的响应会有一定的延迟；
     - 为了保证数据的一致性会对资源暂时锁定，待数据同步完成后释放锁定资源；
     - 如果数据同步失败则节点会返回错误信息，一定不会返回旧数据；
   - Availability：是指任务事务操作都可以得到响应结果，且不会出现响应超时或错误信息，可用性特点：
     - 所有请求都要响应，且不会出现响应超时或错误响应
   - Partition tolerance：通常分布式会部署在不同的网络分区，可能会导致通信失败，但是需要保证可以对外提供服务，分区容错性特点：
     - 是系统必备的基本能力
2. CAP的组合特点：分区容错是必备能力，C和A相互冲突，所以分布式系统只能选CA或者选CP；
   - CP：放弃可用性，保证一致性，保证数据一致性；
   - CA：放弃一致性，容忍数据延迟，如订单生成或评论数据同步；

## 2.2 BASE理论

1. 强一致性和最终一致性：CPA中一致性要求任何时间查询么给节点的数据必须一致，它强调的是强一致性，但是最终一致性是指在一定时间范围内数据不一致，但是在一定时间后保证最终的数据是一致性的；
2. Base理论：是指Basically Availability（基本可用）、Soft State（软状态）、Eventually Consistent（最终一致性）的缩写，Base理论是CPA中AP的一个扩展，通过牺牲强一致性获取可用性；
   - 基本可用：分布式系统出现故障时，运行损失部分可用功能，保证核心功能可用；
   - 软状态：系统不要求一致性，所以BASE运行系统中出现中间状态，不影响系统可用性；
   - 最终一致性：是指经过一定时间后，所有节点的数据将达到一致；

# 第三章 分布式事务方案

## 3.1 2PC

1. 2PC：是指两阶段提交，将事务流程分为两个阶段，准备阶段（Prepare phase），提交阶段（Commit phase）
   - 准备阶段：事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事务，并写入undo/redo日志，此时事务并没有提交；
   - 提交阶段：如果事务管理器收到参与者执行失败信息，直接给每个参与者发送回滚消息，否则发送提交消息，参与者处理事务并释放处理过程中的锁，

## 3.2 实现方案

1. XA方案：

   - 2PC的传统方案是在数据库成迷实现的，如Oracle和MySQL都支持2PC协议，为了统一标准，减少不必要的对接成本，定义了分布式事务处理协议DTP，执行流程：
     - AP（Application Programs）：应用程序，可以理解为使用DTP分布式事务的程序
     - RM（Resource Manager）：资源管理器，可以理解为事务的参与者，
     - TM（Transaction Manager）：事务管理器，负责协调和事务管理，控制全局事务
     - XA：是指TM和RM直接通信的接口规范，即数据库提供的2PC协议接口，基于数据库实现的2PC方案又称为，XA方案
   - XA方案存在的问题：①需要数据库支持DTP协议、②资源锁需要两阶段都结束才会释放

2. Seata方案

   - Seata方案是阿里开发的开源项目，传统的2PC的问题在Seata中得到解决，它是通过对本地数据库的分支事务的协调来驱动完成全局事务，是工作在应用层的中间件；主要特点是性能较好，占用连接资源时长较短，对业务0侵入；目前体用AT模式即TCC模式的分布式事务解决方案；

   - Seata设计思想：把一个分布式事务理解成包含了若干分支事务的全局事务；全局事务的职责是协调其管辖的分支事务达成一致，要么一起提交，要么一起回滚；通常的分支事务本身就是一个关系型数据库的本地事务；

   - Seata定义了三个组件来协调分布式事务的处理过程：

     - Transaction Coordinate（TC）：事务协调器，打算独立的中间件，需要独立部署运行，它维护全局事务的运行状态，接受TM指令发起全局事务的提交或回滚，负责与RM通信协调各个分支事务的提交或回滚
     - Transaction Manger（TM）：事务管理器，TM需要嵌入应用程序中工作，他负责开启一个全局事务，并最终向TC发起全局提交或回滚的指令
     - Resource Manger（RM）：控制分支事务，负责分支注册，状态汇报，并解析事务协调器的指令，驱动分支事务的回滚或提交；

   - 举例Seata分布式事务过程：

     ![image-20220522161912686](.\resource\point11_seata\image-20220522161912686.png)

## 3.3 Seata实现2PC

## 3.4 Seata实现TCC



