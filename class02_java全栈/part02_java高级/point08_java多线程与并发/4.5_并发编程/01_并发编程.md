# 核心知识点概述

- 线程安全
- 线程封闭
- 线程调度
- 同步容器
- 并发容器
- AQS
- JUC

# 第一章 并发基础知识

## 1.1 并发高并发相关概念

### 1. 进程

- 进程是正在运行的程序的实例

- 进程是一个具有一定独立功能的程序关于某个数据集合的一次运行活动。它是操作系统动态执行的基本单元

- 在传统的操作系统中，进程既是基本的分配单元，也是基本的执行单元。

- **进程的概念**

  - 第一，进程是一个实体。每一个进程都有它自己的地址空间

    | 地址空间                | 作用                                               |
    | ----------------------- | -------------------------------------------------- |
    | 文本区域（text region） | 文本区域存储处理器执行的代码                       |
    | 数据区域（data region） | 数据区域存储变量和进程执行期间使用的动态分配的内存 |
    | 堆栈（stack region）    | 堆栈区域存储着活动过程调用的指令和本地变量。       |

  - 第二，进程是一个“执行中的程序”。程序是一个没有生命的实体，只有处理器赋予程序生命时（操作系统执行之），它才能成为一个活动的实体，我们称其为进程。

### 2. 线程

- 是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位
- 一个进程中可以并发多个线程，每条线程并行执行不同的任务
- 同一进程中的多条线程将共享该进程中的全部系统资源
- 线程有时又被称为轻权进程或轻量级进程，也是 CPU 调度的一个基本单位。CUP在同一时间只会执行一条线程

### 3. 并发

- 并发是单个CPU把运行时间划分成若干个时间段，每个时间段再分配给各个线程执行，当一个线程在运行时，其它线程处于挂起状。从宏观角度是同时进行的，但从微观角度并不是同时进行。
- 并发时同时拥有多个线程再处理器上运行,并且多个线程将交替的换入或者换出内存 
  - 多线程操作相同资源 : 保证线程安全并且资源可以合理利用

### 4. 高并发

- 高并发（High Concurrency）是互联网分布式系统架构设计中必须考虑的因素之一，它通常是指，通过设计保证系统能够同时并行处理很多请求。

- 高并发相关常用的一些指标

  | 指标                              | 说明                       |
  | --------------------------------- | -------------------------- |
  | 响应时间（Response Time）         | 系统对请求做出响应的时间   |
  | 吞吐量（Throughput）              | 单位时间内处理的请求数量。 |
  | 每秒查询率QPS（Query Per Second） | 每秒响应请求数。           |
  | 并发用户数                        | 每秒响应请求数。           |

## 1.2 CUP多级缓存

### 1. 为什么使用CPU换出

- CPU频率太快,快到主存跟不上,在处理器处理周期内,CPU常常需要等待主存,浪费资源
- 缓存是为了缓解CPU和主存之间的速率不匹配问题

### 2. CPU缓存作用

- 时间局部性 : 如果数据被访问,在不久的将来可能会被再次访问
- 空间局部性 : 如果数据被访问,在不久的将来与之相邻的数据可能很快被访问

### 3. 缓存一致性

- MESI协议 : 用于保证CPU缓存与主存之间的数据一致性

  | 协议                | 协议说明                                                     |
  | ------------------- | ------------------------------------------------------------ |
  | M(Modified):修改    | 缓存行存在于CPU缓存中,并且缓存行中的数据被修改<br />缓存行数据与主存数据不一致,需要将缓存中数据写回到主存 |
  | E(Exclusive) : 独享 | 从主存中得到数据并缓存到CPU缓存中,此时缓存行数据被CPU独享    |
  | S(Share) : 共享     | 该缓存行被多个CPU使用,并且与主存数据保持一致                 |
  | I(Invalid) : 无效   | 被多个CPU共享的缓存行被一个CPU修改,其他CPU缓存中数据则无效   |

- 缓存一致性相关操作

  | 操作         | 说明                 |
  | ------------ | -------------------- |
  | Local Read   | 读取本地缓存         |
  | Local Write  | 将数据写入到本地缓存 |
  | Remote Read  | 读取主存数据         |
  | Remote Write | 写回到主存中         |

### 4. CPU乱序执行优化

- CPU为提高执行速度而做出违背代码原则的顺序的优化

## 1.3 Java内存模型



## 1.4 并发优势与风险

### 1. 优势

- 速度：同时处理多个请求，响应更快；复杂的操作可以分成多个进程（或线程）同时进行
- 设计：程序设计在某些情况下更简单，也可以有更多的选择
- 资源利用：CPU能够等待IO的时候能够做一些其他的事情
  2、

### 2. 风险

- 安全性：多个线程共享数据时可能会产生于期望不相符的结果
- 活跃性：某个操作无法继续进行下去时，就会发生活跃性问题。比如：死锁、饥饿等问题。
- 性能：线程过多时会使得：CPU频繁切换，调度时间增多；同步机制；消耗过多内存

## 1.5 并发案例

