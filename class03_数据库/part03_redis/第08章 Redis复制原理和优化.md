# 第八章 Redis复制原理和优化

## 1.1 主从复制简介

​		在主从复制中，数据库分为两类，一类是主库(master)，另一类是同步主库数据的从库(slave)。主库可以进行读写操作，当写操作导致数据变化时会自动同步到从库。而从库一般是只读的(特定情况也可以写,通过参数slave-read-only指定)，并接受来自主库的数据，一个主库可拥有多个从库，而一个从库只能有一个主库

## 1.2 主从复制的作用

1. **单机的问题：**
    - 机器故障：导致redis不可用
    - 容量瓶颈：容量不能水平扩展
    - QPS瓶颈：一台机器的网络带宽总是有限的，如果能够分配到多台机器，可以有效解决QPS问题

2. **主从复制的作用**
    - 数据副本：多一份数据副本，保证redis高可用
    - 扩展性能：如容量、QPS等

## 1.3 主从配置

1. 方式一:命令行,不便于管理,即时生效

    ```sh
    # 在命令行执行命令,表示将本服务器作为slave作为指定主机的从节点
    slaveof <IP> <PORT>
    
    # 取消复制
    slaveof no one
    ```

    - 指定了主节点后,从节点的数据会被清除,重新复制主节点数据
    - 从主节点断开后,从节点数据不会被清除

2. 方式二:配置文件(需要重启,方便管理)

    ```properties
    slaveof IP 端口
    slave-read-only yes  # 从节点做只读操作
    ```
    
    ```sh
    info replication # 查看Redis分片信息
    ```

## 1.4 全量复制与部分复制

1. 复制相关概念
    - **runid**：每次启动redis都会分配一个id，重启之后runid变化。 
    - **offset**：执行完成复制之后，从节点会记录偏移量，再次复制时，用偏移量作为复制依据，与主节点同步更新
    - **repl_backlog_size**：复制缓冲区大小，默认为1M，部分复制的时候，如果offset在这个范围内，则开始部分复制，否者要进行全量复制。可以修改这个大小以达到更好地复制机制。
2. 全量复制
- **原理**：
   - **存在的问题**：
3. 部分复制
    - **原理**：
    - **存在的问题**：

## 1.5 故障处理

- 当服务出现问题，可以从故障服务转移到另一个正常的服务；
- slave故障：只需要将客户端连接转移到另一个服务；
- master故障：将其中一个从节点改为master，其他的从节点连接到新的maste上；
- 主从复制不会实现故障转移

## 1.6 优化

1. 读写分离：读流量分摊到从节点
   - 复制数据可能存在延迟
   - 可能会读到过期数据，需要定期处理
   - 从节点故障，迁移到另一个从节点
2. 配置不一致：可能会丢失数据
3. 规避全量复制
   - 第一次全量复制无法规避，可以在低峰时处理
   - 复制积压缓冲区不足，适当的设置合理的缓冲区大小
4. 复制风暴